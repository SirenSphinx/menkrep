name: Build MultiMC for Windows

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    env:
      INSTALL_DIR: "install"
      BUILD_DIR: "build"

    steps:
      # 1. Mengunduh kode sumber
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 2. Menyiapkan MSYS2 dan dependensi
      - name: Setup MSYS2 Environment and Dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: git
          pacboy: >-
            toolchain:p
            cmake:p
            ninja:p
            extra-cmake-modules:p
            qt5-base:p
            qt5-svg:p
            qt5-imageformats:p
            qt5-charts:p
            quazip-qt5:p

      # 3. Konfigurasi proyek dan simpan log-nya
      - name: Configure CMake
        id: configure_step
        continue-on-error: true # Terus berjalan meskipun error, agar bisa upload log
        shell: msys2 {0}
        run: |
          cmake -S . -B ${{ env.BUILD_DIR }} `
            -G Ninja `
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }} `
            -DCMAKE_BUILD_TYPE=Release `
            -DLauncher_QT_VERSION_MAJOR=5 > configure_log.txt 2>&1

      # 4. Mengunggah log konfigurasi jika terjadi error
      - name: Upload Configure Log on Failure
        if: steps.configure_step.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: configure-failure-log
          path: configure_log.txt

      # 5. Hentikan workflow jika konfigurasi gagal
      - name: Check configure status
        if: steps.configure_step.outcome == 'failure'
        run: exit 1

      # 6. Meng-compile proyek
      - name: Build Project
        shell: msys2 {0}
        run: |
          cmake --build ${{ env.BUILD_DIR }}

      # 7. Menginstal aplikasi
      - name: Install Application
        shell: msys2 {0}
        run: |
          cmake --install ${{ env.BUILD_DIR }}

      # 8. Mengunggah hasil build
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MultiMC-Windows-Build
          path: ${{ env.INSTALL_DIR }}/**
