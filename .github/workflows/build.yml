name: Build MultiMC for Windows

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    env:
      INSTALL_DIR: "install"
      BUILD_DIR: "build"

    steps:
      # 1. Mengunduh kode sumber
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 2. Menyiapkan MSYS2 dan semua dependensi menggunakan metode resmi
      - name: Setup MSYS2 Environment and Dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64  # Menggunakan arsitektur 64-bit
          update: true
          install: git
          pacboy: >-      # Menggunakan 'pacboy' seperti pada workflow resmi
            toolchain:p
            cmake:p
            ninja:p
            extra-cmake-modules:p
            qt5-base:p
            qt5-svg:p
            qt5-imageformats:p
            qt5-charts:p
            quazip-qt5:p

      # 3. Konfigurasi proyek menggunakan CMake
      - name: Configure CMake
        shell: msys2 {0}
        run: |
          cmake -S . -B ${{ env.BUILD_DIR }} `
            -G Ninja `
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }} `
            -DCMAKE_BUILD_TYPE=Release `
            -DLauncher_QT_VERSION_MAJOR=5

      # 4. Meng-compile proyek
      - name: Build Project
        shell: msys2 {0}
        run: |
          cmake --build ${{ env.BUILD_DIR }}

      # 5. Menginstal aplikasi ke direktori 'install'
      - name: Install Application
        shell: msys2 {0}
        run: |
          cmake --install ${{ env.BUILD_DIR }}

      # 6. Mengunggah hasil build sebagai artifact
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MultiMC-Windows-Build
          path: ${{ env.INSTALL_DIR }}/**
